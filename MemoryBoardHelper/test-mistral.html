<!DOCTYPE html>
<!--
    Mistral AI Test Suite - Memory Board Helper
    Version: 2.0 (17 d√©cembre 2025 - 16:30)
    
    CHANGEMENTS v2.0:
    - ‚úÖ Int√©gration des vrais prompts de mistral-agent.js (TASK_PROMPT, NAV_PROMPT, CALL_PROMPT, DEFAULT_CHAT_PROMPT)
    - ‚úÖ Fonction detectActionByKeywords() identique √† l'app principale
    - ‚úÖ sendToMistral() s√©lectionne automatiquement le bon prompt selon l'action d√©tect√©e
    - ‚úÖ Temp√©rature r√©duite √† 0.3 pour plus de coh√©rence
    - ‚úÖ Ajout response_format: json_object pour forcer JSON valide
    
    Ce fichier de test utilise maintenant exactement la m√™me logique que l'application principale.
-->
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mistral AI Test Suite v2.0 - Memory Board Helper</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root {
            --primary-color: #4a9eff;
            --primary-dark: #0d4fff;
            --secondary-color: #404040;
            --background-color: #1a1a1a;
            --surface-color: #2a2a2a;
            --surface-elevated: #3a3a3a;
            --text-color: #e0e0e0;
            --text-muted: #888;
            --border-color: #3a3a3a;
            --error-color: #ff4444;
            --success-color: #44ff88;
            --warning-color: #ffaa44;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            vertical-align: middle;
            user-select: none;
        }

        .header {
            background-color: var(--surface-color);
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header-title h1 {
            color: #ffffff;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header-title p {
            color: var(--text-muted);
            font-size: 14px;
        }

        .credits {
            color: var(--text-muted);
            font-size: 14px;
            text-align: right;
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
        }

        .api-key-section {
            background-color: var(--surface-color);
            padding: 25px;
            margin-bottom: 20px;
        }

        .api-key-section label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
            font-weight: 500;
        }

        .api-key-section input {
            width: 100%;
            padding: 12px;
            background-color: var(--background-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            font-size: 16px;
            margin-bottom: 12px;
        }

        .hint {
            color: var(--text-muted);
            font-size: 13px;
        }

        .hint a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .control-section {
            background-color: var(--surface-color);
            padding: 20px;
            margin-bottom: 20px;
        }

        .control-section h2 {
            color: #ffffff;
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .test-card {
            background-color: var(--background-color);
            padding: 15px;
            border: 1px solid var(--border-color);
        }

        .test-card.running {
            border-color: var(--warning-color);
        }

        .test-card.success {
            border-color: var(--success-color);
        }

        .test-card.failed {
            border-color: var(--error-color);
        }

        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .test-lang {
            background: var(--secondary-color);
            padding: 3px 8px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .test-command {
            color: var(--primary-color);
            font-weight: 500;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .test-expected {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 10px;
        }

        .test-result {
            padding: 10px;
            background-color: var(--surface-color);
            margin-top: 10px;
            font-size: 13px;
        }

        .test-result.success {
            border-left: 3px solid var(--success-color);
        }

        .test-result.failed {
            border-left: 3px solid var(--error-color);
        }

        .test-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-small {
            padding: 8px 12px;
            background-color: var(--primary-color);
            color: #ffffff;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-small:hover {
            background-color: var(--primary-dark);
        }

        .btn-small:disabled {
            background-color: var(--text-muted);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background-color: var(--surface-elevated);
        }

        .btn-primary {
            padding: 15px 25px;
            background-color: var(--primary-color);
            color: #ffffff;
            border: none;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-primary:disabled {
            background-color: var(--text-muted);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: var(--background-color);
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 14px;
        }

        .loading-indicator {
            text-align: center;
            padding: 30px;
        }

        .spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .new-test-form {
            background-color: var(--background-color);
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .new-test-form.show {
            display: block;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
            font-weight: 500;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px;
            background-color: var(--surface-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            font-size: 16px;
        }

        .log-console {
            background-color: #000;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #0f0;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-entry.error {
            color: var(--error-color);
        }

        .log-entry.success {
            color: var(--success-color);
        }

        .log-entry.warning {
            color: var(--warning-color);
        }

        .export-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-title">
            <h1>üß™ Mistral AI Test Suite v2.0</h1>
            <p>Test automatis√© de reconnaissance des actions vocales - Utilise les prompts complets de l'app principale</p>
        </div>
        <div class="credits">
            <span>CraftKontrol ¬© 2025</span>
        </div>
    </header>

    <main class="main-content">
        <section class="api-key-section">
            <label for="apiKey">Mistral API Key:</label>
            <input type="password" id="apiKey" placeholder="Entrez votre cl√© API Mistral..." />
            <span class="hint">R√©cup√©rez votre cl√© depuis <a href="https://console.mistral.ai/" target="_blank">console.mistral.ai</a></span>
        </section>

        <section class="control-section">
            <h2>
                <span class="material-symbols-outlined">analytics</span>
                Statistiques
            </h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="statTotal">0</div>
                    <div class="stat-label">Tests totaux</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statSuccess" style="color: var(--success-color);">0</div>
                    <div class="stat-label">R√©ussis</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statFailed" style="color: var(--error-color);">0</div>
                    <div class="stat-label">√âchou√©s</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statRate">0%</div>
                    <div class="stat-label">Taux de succ√®s</div>
                </div>
            </div>

            <button class="btn-primary" id="runAllBtn" onclick="runAllTests()">
                <span class="material-symbols-outlined">play_arrow</span>
                Lancer tous les tests
            </button>
            <button class="btn-primary btn-secondary" onclick="toggleNewTestForm()">
                <span class="material-symbols-outlined">add</span>
                Ajouter un test
            </button>

            <div class="new-test-form" id="newTestForm">
                <h3 style="margin-bottom: 15px;">Nouveau test</h3>
                <div class="input-group">
                    <label for="testCommand">Commande vocale</label>
                    <input type="text" id="testCommand" placeholder="Rappelle-moi de prendre mes m√©dicaments demain √† 8h" />
                </div>
                <div class="input-group">
                    <label for="testLanguage">Langue</label>
                    <select id="testLanguage">
                        <option value="fr">Fran√ßais</option>
                        <option value="en">English</option>
                        <option value="it">Italiano</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="testExpectedAction">Action attendue</label>
                    <select id="testExpectedAction">
                        <option value="add_task">add_task</option>
                        <option value="add_list">add_list</option>
                        <option value="add_note">add_note</option>
                        <option value="complete_task">complete_task</option>
                        <option value="delete_task">delete_task</option>
                        <option value="update_task">update_task</option>
                        <option value="search_task">search_task</option>
                        <option value="goto_section">goto_section</option>
                        <option value="call">call</option>
                        <option value="undo">undo</option>
                        <option value="conversation">conversation</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="addCustomTest()">Ajouter</button>
            </div>

            <div class="export-controls">
                <button class="btn-small" onclick="exportResults()">
                    <span class="material-symbols-outlined">download</span>
                    Exporter r√©sultats
                </button>
                <button class="btn-small btn-secondary" onclick="clearResults()">
                    <span class="material-symbols-outlined">delete</span>
                    Effacer r√©sultats
                </button>
            </div>
        </section>

        <section class="control-section">
            <h2>
                <span class="material-symbols-outlined">list</span>
                Tests de commandes (<span id="testCount">0</span>)
            </h2>
            <div id="loadingIndicator" class="loading-indicator" style="display: none;">
                <div class="spinner"></div>
                <p>Tests en cours...</p>
            </div>
            <div class="test-grid" id="testGrid"></div>
        </section>

        <section class="control-section">
            <h2>
                <span class="material-symbols-outlined">terminal</span>
                Console de logs
            </h2>
            <div class="log-console" id="logConsole"></div>
        </section>
    </main>

    <script>
        // Prompts import√©s de mistral-agent.js (version compl√®te)
        const TASK_PROMPT = `You are a helpful memory assistant for elderly or memory-deficient persons. Your role is to:
1. Understand natural language requests in French, Italian, or English
2. Extract task, list, or note information from user requests
3. Detect when tasks are completed from user statements
4. Detect when the user wants to modify (change/update) the date or time of an existing task
5. Detect when the user asks about an existing task
6. Detect when the user wants to create a LIST (with multiple items) or a NOTE (with content)
7. USE CONVERSATION HISTORY to resolve context references
8. Provide clear, simple, and reassuring responses
9. Be patient, kind, and use simple language

When extracting tasks, respond in JSON format with:
{
    "action": "add_task|add_list|add_note|complete_task|delete_task|delete_list|delete_note|update_task|update_list|update_note|search_task|undo|conversation|add_recursive_task|delete_old_task|delete_done_task",
    "task": {
        "description": "clear task description",
        "date": "YYYY-MM-DD if mentioned, else null",
        "time": "HH:MM format if mentioned, else null",
        "type": "general|medication|appointment|call|shopping",
        "priority": "normal|urgent|low",
        "recurrence": "null|daily|weekly|monthly (if user mentions recurring/tous les jours/chaque semaine/chaque mois)"
    },
    "list": {
        "title": "list title (or search term for delete/update)",
        "items": ["item 1", "item 2", "item 3"],
        "category": "general|shopping|todo|ideas|goals"
    },
    "note": {
        "title": "note title (or search term for delete/update)",
        "content": "note content",
        "category": "general|personal|work|ideas|reminder"
    },
    "taskId": "id if completing, deleting or updating existing task",
    "response": "friendly message to user",
    "language": "fr|it|en"
}

‚ö†Ô∏è ULTRA-CRITICAL PRIORITY RULES (NEVER VIOLATE):
1. NEVER classify these as "conversation" - they are ALWAYS actions:
   - ANY phrase with "N'oublie pas" ‚Üí ALWAYS add_task
   - ANY phrase starting with "Rendez-vous" or "Prendre" ‚Üí ALWAYS add_task or add_recursive_task
   - ANY phrase with "annule" + "action" OR "d√©fais" + "ce que" ‚Üí ALWAYS undo
   - ANY phrase with "modifie" + "rendez-vous/t√¢che/heure" ‚Üí ALWAYS update_task
2. If unsure between task and conversation, ALWAYS choose task (safer)
3. Conversation ONLY for: greetings, thanks, pure questions with NO action

CRITICAL DETECTION RULES:

üî¥ NOTES vs TASKS (MOST IMPORTANT):
- Use "add_note" when user says:
  * "prends note que" / "prends note de" / "take note that"
  * "note que" / "note:" / "noter que"
  * "ajoute une note" / "cr√©e une note" / "add a note" / "create a note"
  * "nouvelle note" / "new note"
- Use "add_task" when user says:
  * "rappelle-moi" / "remind me" / "ricordami"
  * "ajoute une t√¢che" / "cr√©e une t√¢che" / "add a task"
  * "n'oublie pas" / "don't forget" / "non dimenticare"
  * Mentions specific time/date for action
  * Declarative appointment: "Rendez-vous X" / "Appointment X" / "Appuntamento X"
  * Imperative medication: "Prendre X" / "Take X" / "Prendere X" (without "note")

üî¥ DECLARATIVE & IMPERATIVE PHRASES (CRITICAL - HIGHEST PRIORITY):
When user states an action WITHOUT explicit "rappelle-moi/ajoute/cr√©e", it is STILL a task if it:
- Mentions appointment: "Rendez-vous X" / "Appointment X" / "Appuntamento X"
- Imperative medication: "Prendre X" / "Take X" / "Prendere X"
- "N'oublie pas de X" / "Don't forget to X" / "Non dimenticare X"
- Has time/date context: "X demain √† 14h" / "X lundi prochain"

EXAMPLES (FOLLOW EXACTLY):
- "Rendez-vous chez le dentiste demain √† 14h" ‚Üí add_task (NOT conversation!)
- "Prendre aspirine 500mg" ‚Üí add_task or add_recursive_task if recurring
- "N'oublie pas de sortir les poubelles" ‚Üí add_task (NOT conversation!)
- "Rendez-vous m√©decin tous les mois" ‚Üí add_recursive_task (NOT conversation!)

NEVER respond with "conversation" for these - they are ALWAYS tasks!

üî¥ LISTS:
- Use "add_list" when:
  * User explicitly says "cr√©e une liste" / "nouvelle liste" / "create a list" / "new list"
  * OR user says "liste de X" followed by items ("liste de courses: pain, lait, ≈ìufs")
  * OR when user enumerates 3+ distinct actions/tasks in one message WITHOUT "√† ma liste"
  * Examples: "faire le caf√© faire les courses faire un bisou" ‚Üí add_list with 3 items
  * "liste de courses: pain du lait et des ≈ìufs" ‚Üí add_list with 3 items
- Use "update_list" when:
  * "ajoute X √† ma liste" / "rajoute X dans la liste" / "add X to my list" (explicit "√† ma/to my")
  * Extract list name from context and items to add
  * Example: "ajoute pommes √† ma liste de courses" ‚Üí update_list
- Use "delete_list" when:
  * "supprime la liste" / "efface la liste" / "delete the list"
  * Extract list name or "derni√®re" if they want most recent

üî¥ RECURRING TASKS:
- Use "add_recursive_task" (NOT add_task) when user mentions:
  * "tous les jours" / "quotidien" / "chaque jour" / "every day" / "daily" ‚Üí recurrence: "daily"
  * "chaque semaine" / "tous les lundis" / "hebdomadaire" / "every week" / "weekly" ‚Üí recurrence: "weekly"
  * "chaque mois" / "tous les mois" / "mensuel" / "every month" / "monthly" ‚Üí recurrence: "monthly"
  * "t√¢che r√©currente" / "recurring task" ‚Üí use add_recursive_task
  * "trois fois par jour" / "twice a day" ‚Üí recurrence: "daily" (mention frequency in description)
- Set recurrence field in task object with appropriate value

For search_task action, use when the user asks about an existing task (e.g., "c'est quand mon rendez-vous?", "when is my appointment?", "quand ai-je mon m√©dicament?", "montre-moi la t√¢che", "show me the task"). 
ALSO use search_task when the user wants to list/view multiple tasks (e.g., "liste tous mes rendez-vous", "list all my appointments", "quels sont mes rendez-vous", "what are my appointments").
IMPORTANT: If the user says "la t√¢che" or "the task" without specifying which one, check the conversation history to find what task was discussed in recent messages and use that task description for the search.
For list requests (tous/toutes/all/liste), extract ONLY the task type, not a specific description. For example: "tous mes rendez-vous" ‚Üí task.type = "appointment", task.description = "rendez-vous" (generic).

For update_task action, ALWAYS use when user says ANY of these keywords:
- "modifie" + ("heure" / "date" / "rendez-vous" / "t√¢che") ‚Üí update_task (NOT conversation!)
- "change" / "d√©place" / "move" / "update" / "cambia"
- "change l'heure" / "modifie la date" / "d√©place le rendez-vous"
IMPORTANT: Extract task description and new time/date. NEVER respond with conversation for modification requests!

For delete_old_task action, use when user wants to delete ALL past/old tasks. Keywords: "toutes les t√¢ches pass√©es" / "anciennes t√¢ches" / "old tasks" / "past tasks" / "t√¢ches p√©rim√©es".

For delete_done_task action, use when user wants to delete ALL completed/done tasks. Keywords: "t√¢ches termin√©es" / "t√¢ches compl√©t√©es" / "completed tasks" / "done tasks" / "finished tasks".

For delete_task action, identify which task the user wants to remove/delete/cancel/supprimer/annuler/cancellare/effacer. This includes requests with:
- "supprime la/les t√¢che(s)" - delete the task(s)
- "efface la/les t√¢che(s)" - erase the task(s)  
- "supprime toutes les t√¢ches" - delete all tasks
- "supprime les t√¢ches pass√©es/anciennes" - delete past/old tasks
- "delete all tasks", "cancella tutti i compiti"
Check conversation history if the user says "delete the task" or "supprime la t√¢che" without specifying which one.
IMPORTANT: For vague deletion requests (all, old, past tasks), extract generic description like "toutes", "pass√©es", "anciennes" so the app can ask for clarification.

For delete_list action, use when the user wants to delete/remove a list. Examples: "efface la liste", "supprime la derni√®re liste", "delete the list". Extract the list title or "derni√®re/last" if they want the most recent one.

For delete_note action, use when the user wants to delete/remove a note. Examples: "efface la note", "supprime la note sur", "delete the note". Extract the note title or content keywords.

For complete_task action, check conversation history if the user says "mark it as done" or "marque-la comme faite" without specifying the task.

For undo action, ALWAYS use when user says ANY of these:
- "annule" / "annuler" + "action" / "derni√®re" / "dernier" / "la derni√®re"
- "d√©fais" / "d√©faire" + "ce que" / "√ßa" / "cela"
- "undo" / "retour" / "revenir en arri√®re" / "annulla"
- "annule la derni√®re action" ‚Üí undo (NOT conversation!)
- "d√©fais ce que je viens de faire" ‚Üí undo (NOT conversation!)
IMPORTANT: These phrases are NEVER conversations, always undo action!

üî¥ CRITICAL: Always respect the ACTION VERB in the user's request:
- "Ajoute X √† ma liste" ‚Üí update_list (NOT add_list)
- "Supprime la liste" ‚Üí delete_list (NOT delete_task)
- "Supprime la note" ‚Üí delete_note (NOT delete_task)
- "Prends note que" ‚Üí add_note (NOT add_task)

For medication tasks, extract dosage information in the description.

üéØ EXAMPLES (FOLLOW THESE EXACTLY):

‚úÖ LISTES:
User: "Ajoute pommes et bananes √† ma liste de courses"
Response: {"action": "update_list", "list": {"title": "courses", "items": ["pommes", "bananes"]}, "response": "J'ai ajout√© pommes et bananes √† votre liste.", "language": "fr"}

User: "Supprime ma liste de courses"
Response: {"action": "delete_list", "list": {"title": "courses"}, "response": "Je supprime la liste des courses.", "language": "fr"}

User: "Cr√©e une liste pour le weekend"
Response: {"action": "add_list", "list": {"title": "weekend", "items": []}, "response": "Liste cr√©√©e.", "language": "fr"}

‚úÖ NOTES:
User: "Prends note que je dois appeler le plombier"
Response: {"action": "add_note", "note": {"content": "je dois appeler le plombier", "category": "general"}, "response": "Note enregistr√©e.", "language": "fr"}

User: "Ajoute √† ma note de meeting la discussion budget"
Response: {"action": "update_note", "note": {"title": "meeting", "content": "discussion budget"}, "response": "Ajout√© √† votre note meeting.", "language": "fr"}

User: "Efface la note sur le m√©decin"
Response: {"action": "delete_note", "note": {"title": "m√©decin"}, "response": "Note supprim√©e.", "language": "fr"}

‚úÖ T√ÇCHES R√âCURRENTES:
User: "Rappelle-moi de prendre mes vitamines tous les jours √† 8h"
Response: {"action": "add_recursive_task", "task": {"description": "prendre vitamines", "time": "08:00", "type": "medication", "priority": "normal", "recurrence": "daily"}, "response": "Rappel quotidien ajout√©.", "language": "fr"}

User: "Rendez-vous m√©decin tous les mois le 15"
Response: {"action": "add_recursive_task", "task": {"description": "rendez-vous m√©decin", "date": "15", "type": "appointment", "priority": "normal", "recurrence": "monthly"}, "response": "Rendez-vous mensuel cr√©√©.", "language": "fr"}

User: "Prendre aspirine 500mg trois fois par jour"
Response: {"action": "add_recursive_task", "task": {"description": "prendre aspirine 500mg trois fois par jour", "type": "medication", "recurrence": "daily"}, "response": "Rappel quotidien cr√©√©.", "language": "fr"}

‚úÖ PHRASES D√âCLARATIVES:
User: "Rendez-vous chez le dentiste lundi prochain √† 14h30"
Response: {"action": "add_task", "task": {"description": "rendez-vous dentiste", "date": "2025-12-22", "time": "14:30", "type": "appointment"}, "response": "Rendez-vous ajout√©.", "language": "fr"}

User: "N'oublie pas de sortir les poubelles ce soir"
Response: {"action": "add_task", "task": {"description": "sortir les poubelles", "date": "2025-12-17", "time": "20:00", "type": "general"}, "response": "Je vous le rappellerai.", "language": "fr"}

‚úÖ SUPPRESSION SP√âCIALE:
User: "Efface toutes mes t√¢ches pass√©es"
Response: {"action": "delete_old_task", "response": "Je supprime toutes les t√¢ches pass√©es.", "language": "fr"}

User: "Supprime les t√¢ches termin√©es"
Response: {"action": "delete_done_task", "response": "Je supprime les t√¢ches termin√©es.", "language": "fr"}

‚úÖ UNDO:
User: "Annule la derni√®re action"
Response: {"action": "undo", "response": "J'annule la derni√®re action.", "language": "fr"}

User: "D√©fais ce que je viens de faire"
Response: {"action": "undo", "response": "C'est annul√©.", "language": "fr"}

‚úÖ UPDATE TASK:
User: "Modifie l'heure de mon rendez-vous √† 15h"
Response: {"action": "update_task", "task": {"description": "rendez-vous", "time": "15:00"}, "response": "Heure modifi√©e.", "language": "fr"}

Always be encouraging and supportive.`;

        const NAV_PROMPT = `You are a navigation assistant for elderly or memory-deficient persons. Your role is to:
1. Understand natural language requests in French, Italian, or English
2. Identify navigation intents to sections or pages of the application
3. Focus to the requested section or page
4. Confirm navigation actions with the user
5. Provide clear, simple, and reassuring responses
6. Be patient, kind, and use simple language

Available sections:
- "tasks": Task list section
- "calendar": Calendar view section
- "settings": Settings/options section
- "stats": Statistics section

KEYWORDS FOR NAVIGATION:
üî¥ CALENDAR: "calendrier" / "calendar" / "planning" / "agenda" / "montre-moi le calendrier" / "show me calendar" / "va au calendrier" / "go to calendar"
üî¥ SETTINGS: "param√®tres" / "settings" / "r√©glages" / "options" / "configuration" / "affiche les param√®tres" / "show settings" / "va dans les param√®tres"
üî¥ STATS: "statistiques" / "statistics" / "stats" / "rapports" / "reports" / "va dans les statistiques" / "show stats"
üî¥ TASKS: "t√¢ches" / "tasks" / "liste" / "todo" / "affiche les t√¢ches" / "show tasks" / "retour aux t√¢ches"

IMPORTANT: Always use action "goto_section" when user wants to navigate, NEVER use "search_task" or other actions.

Respond in JSON format with:
{
    "action": "goto_section",
    "section": "tasks|calendar|settings|stats",
    "response": "friendly message to user",
    "language": "fr|it|en"
}

EXAMPLES:
- "Montre-moi le calendrier" ‚Üí {"action": "goto_section", "section": "calendar"}
- "Affiche les param√®tres" ‚Üí {"action": "goto_section", "section": "settings"}
- "Va dans les statistiques" ‚Üí {"action": "goto_section", "section": "stats"}
- "Show me the calendar" ‚Üí {"action": "goto_section", "section": "calendar"}

Always be encouraging and supportive.`;

        const CALL_PROMPT = `You are an emergency call assistant for elderly or memory-deficient persons. Your role is to:
1. Understand natural language call requests in French, Italian, or English
2. Identify which emergency contact the user wants to call (if specified)
3. Confirm the call action with a reassuring message
4. Be patient, kind, and use simple language

KEYWORDS FOR CALLS:
üî¥ CALL ACTION VERBS:
- French: "appelle" / "t√©l√©phone" / "appeler" / "t√©l√©phoner" / "compose" / "passe-moi"
- English: "call" / "phone" / "dial" / "ring"
- Italian: "chiama" / "telefona" / "chiamare"

üî¥ EMERGENCY KEYWORDS:
- "urgences" / "emergency" / "emergenza" / "911" / "15" / "112"
- "aide" / "help" / "aiuto" / "secours"

IMPORTANT: Always use action "call", NEVER use "add_task" for call requests.

When the user wants to make a call, respond in JSON format with:
{
    "action": "call",
    "contactName": "name of the contact if mentioned, else null",
    "response": "friendly confirmation message",
    "language": "fr|it|en"
}

EXAMPLES:
- "Appelle les urgences" ‚Üí {"action": "call", "contactName": "urgences"}
- "T√©l√©phone √† maman" ‚Üí {"action": "call", "contactName": "maman"}
- "Call emergency" ‚Üí {"action": "call", "contactName": "emergency"}
- "Appelle Arnaud" ‚Üí {"action": "call", "contactName": "Arnaud"}
- "T√©l√©phone au docteur" ‚Üí {"action": "call", "contactName": "docteur"}

Always be encouraging and supportive.`;

        const DEFAULT_CHAT_PROMPT = `You are a helpful memory assistant for elderly or memory-deficient persons. Your role is to:
1. Understand natural language requests in French, Italian, or English
2. Answer general questions (time, date, day, weather, info)
3. Have friendly conversations
4. Provide clear, simple, and reassuring responses
5. Be patient, kind, and use simple language

For questions about time/date:
- Get current time/date from the context provided
- Format responses naturally and friendly

Respond in JSON format with:
{
    "action": "conversation",
    "response": "friendly message to user (include time/date if asked)",
    "language": "fr|it|en"
}

EXAMPLES:
- "Quelle heure est-il" ‚Üí {"action": "conversation", "response": "Il est 14h30."}
- "Quelle date sommes-nous" ‚Üí {"action": "conversation", "response": "Nous sommes le 17 d√©cembre 2025."}
- "Quel jour" ‚Üí {"action": "conversation", "response": "Nous sommes mardi."}

Always be encouraging and supportive.`;

        // Test cases configurables
        let testCases = [
            // FRAN√áAIS - T√¢ches g√©n√©rales
            { command: "Rappelle-moi d'acheter du pain demain √† 8h", language: "fr", expectedAction: "add_task", type: "task" },
            { command: "Ajoute une t√¢che pour appeler le m√©decin", language: "fr", expectedAction: "add_task", type: "task" },
            { command: "Cr√©e une t√¢che envoyer l'email urgent", language: "fr", expectedAction: "add_task", type: "task" },
            { command: "N'oublie pas de sortir les poubelles ce soir", language: "fr", expectedAction: "add_task", type: "task" },
            
            

            // FRAN√áAIS - M√©dicaments
            { command: "Rappelle-moi de prendre mes m√©dicaments √† 20h", language: "fr", expectedAction: "add_task", type: "medication" },
            { command: "Prendre aspirine 500mg trois fois par jour", language: "fr", expectedAction: "add_recursive_task", type: "medication" },
            
            // FRAN√áAIS - Rendez-vous
            { command: "Rendez-vous chez le dentiste lundi prochain √† 14h30", language: "fr", expectedAction: "add_task", type: "appointment" },
            { command: "Ajoute un rendez-vous coiffeur vendredi √† 10h", language: "fr", expectedAction: "add_task", type: "appointment" },
            
            // FRAN√áAIS - Courses
            { command: "Ajoute lait, ≈ìufs et fromage √† ma liste de courses", language: "fr", expectedAction: "update_list", type: "shopping" },
            { command: "Liste de courses: tomates, pain, beurre", language: "fr", expectedAction: "add_list", type: "shopping" },
            
            // FRAN√áAIS - Listes
            { command: "Cr√©e une liste pour mes courses du weekend", language: "fr", expectedAction: "add_list", type: "list" },
            { command: "Nouvelle liste de choses √† faire pour les vacances", language: "fr", expectedAction: "add_list", type: "list" },
            { command: "Ajoute pommes et bananes √† ma liste de courses", language: "fr", expectedAction: "update_list", type: "list" },
            { command: "Rajoute huile d'olive dans la liste de courses", language: "fr", expectedAction: "update_list", type: "list" },
            { command: "Supprime ma liste de courses", language: "fr", expectedAction: "delete_list", type: "list" },
            { command: "Efface la liste des vacances", language: "fr", expectedAction: "delete_list", type: "list" },
            
            // FRAN√áAIS - Notes
            { command: "Cr√©e une note avec mes id√©es de projet", language: "fr", expectedAction: "add_note", type: "note" },
            { command: "Nouvelle note pour le meeting de demain", language: "fr", expectedAction: "add_note", type: "note" },
            { command: "Prends note que je dois appeler le plombier", language: "fr", expectedAction: "add_note", type: "note" },
            { command: "Ajoute √† ma note de meeting la discussion sur le budget", language: "fr", expectedAction: "update_note", type: "note" },
            { command: "Compl√®te ma note projet avec les deadlines", language: "fr", expectedAction: "update_note", type: "note" },
            { command: "Supprime ma note de meeting", language: "fr", expectedAction: "delete_note", type: "note" },
            { command: "Efface la note sur le plombier", language: "fr", expectedAction: "delete_note", type: "note" },
            
            // FRAN√áAIS - Actions sur t√¢ches
            { command: "Marque comme termin√© la t√¢che d'acheter du pain", language: "fr", expectedAction: "complete_task", type: "task" },
            { command: "Supprime la t√¢che d'appeler le m√©decin", language: "fr", expectedAction: "delete_task", type: "task" },
            { command: "Efface la t√¢che de sortir les poubelles", language: "fr", expectedAction: "delete_task", type: "task" },
            { command: "Modifie l'heure de mon rendez-vous √† 15h", language: "fr", expectedAction: "update_task", type: "task" },
            { command: "Cherche mes t√¢ches de la semaine prochaine", language: "fr", expectedAction: "search_task", type: "task" },
            { command: "Montre-moi mes t√¢ches du jour", language: "fr", expectedAction: "search_task", type: "task" },
            { command: "Affiche mes t√¢ches de la semaine", language: "fr", expectedAction: "search_task", type: "task" },
            { command: "Montre la t√¢che d'acheter du pain", language: "fr", expectedAction: "search_task", type: "task" },
            { command: "Affiche la t√¢che du rendez-vous m√©decin", language: "fr", expectedAction: "search_task", type: "task" },
            { command: "Liste mes t√¢ches pass√©es", language: "fr", expectedAction: "search_task", type: "task" },
            { command: "Quelles sont mes anciennes t√¢ches", language: "fr", expectedAction: "search_task", type: "task" },
            { command: "Efface toutes mes t√¢ches pass√©es", language: "fr", expectedAction: "delete_old_task", type: "task" },
            { command: "Supprime les t√¢ches termin√©es", language: "fr", expectedAction: "delete_done_task", type: "task" },
            
            // FRAN√áAIS - T√¢ches r√©currentes
            { command: "Rappelle-moi de prendre mes vitamines tous les jours √† 8h", language: "fr", expectedAction: "add_recursive_task", type: "task", recurrence: "daily" },
            { command: "Cr√©e une t√¢che r√©currente sortir les poubelles chaque lundi", language: "fr", expectedAction: "add_recursive_task", type: "task", recurrence: "weekly" },
            { command: "Rendez-vous m√©decin tous les mois le 15", language: "fr", expectedAction: "add_recursive_task", type: "task", recurrence: "monthly" },
            
            // FRAN√áAIS - Questions g√©n√©rales
            { command: "Quelle heure est-il", language: "fr", expectedAction: "conversation", type: "question" },
            { command: "Quelle est la date aujourd'hui", language: "fr", expectedAction: "conversation", type: "question" },
            { command: "Quel jour sommes-nous", language: "fr", expectedAction: "conversation", type: "question" },
            
            // FRAN√áAIS - Navigation
            { command: "Montre-moi le calendrier", language: "fr", expectedAction: "goto_section", section: "calendar" },
            { command: "Affiche les param√®tres", language: "fr", expectedAction: "goto_section", section: "settings" },
            { command: "Va dans les statistiques", language: "fr", expectedAction: "goto_section", section: "stats" },
            
            // FRAN√áAIS - Appels urgents
            { command: "Appelle les urgences", language: "fr", expectedAction: "call", type: "emergency" },
            { command: "T√©l√©phone √† maman", language: "fr", expectedAction: "call", type: "contact" },
            
            // FRAN√áAIS - Undo
            { command: "Annule la derni√®re action", language: "fr", expectedAction: "undo", type: "undo" },
            { command: "D√©fais ce que je viens de faire", language: "fr", expectedAction: "undo", type: "undo" },
            { command: "Retour en arri√®re", language: "fr", expectedAction: "undo", type: "undo" },
            { command: "Annule √ßa", language: "fr", expectedAction: "undo", type: "undo" },
            
            // FRAN√áAIS - Phrases d√©claratives vari√©es
            { command: "Rendez-vous kin√© demain matin 9h", language: "fr", expectedAction: "add_task", type: "appointment" },
            { command: "Prendre doliprane apr√®s les repas", language: "fr", expectedAction: "add_recursive_task", type: "medication" },
            { command: "N'oublie pas le rendez-vous banque jeudi", language: "fr", expectedAction: "add_task", type: "appointment" },
            { command: "N'oublie pas d'arroser les plantes", language: "fr", expectedAction: "add_task", type: "task" },
            { command: "Prendre antibiotique matin et soir pendant 7 jours", language: "fr", expectedAction: "add_recursive_task", type: "medication" },
            
            // FRAN√áAIS - M√©dicaments avec horaires complexes
            { command: "Rappelle-moi mon insuline avant chaque repas", language: "fr", expectedAction: "add_recursive_task", type: "medication" },
            { command: "Prendre vitamine D une fois par semaine le dimanche", language: "fr", expectedAction: "add_recursive_task", type: "medication", recurrence: "weekly" },
            { command: "Ajoute t√¢che prendre tension tous les matins √† 8h", language: "fr", expectedAction: "add_recursive_task", type: "medication" },
            
            // FRAN√áAIS - Rendez-vous vari√©s
            { command: "Rendez-vous ophtalmo le 20 janvier √† 15h", language: "fr", expectedAction: "add_task", type: "appointment" },
            { command: "Ajoute contr√¥le technique voiture mardi prochain", language: "fr", expectedAction: "add_task", type: "appointment" },
            { command: "N'oublie pas mon rendez-vous cardiologue vendredi 14h", language: "fr", expectedAction: "add_task", type: "appointment" },
            
            // FRAN√áAIS - Modifications complexes
            { command: "Change la date de mon rendez-vous dentiste", language: "fr", expectedAction: "update_task", type: "task" },
            { command: "D√©place mon rendez-vous √† demain m√™me heure", language: "fr", expectedAction: "update_task", type: "task" },
            { command: "Modifie ma t√¢che courses pour samedi", language: "fr", expectedAction: "update_task", type: "task" },
            
            // FRAN√áAIS - Listes avec √©num√©rations
            { command: "Faire le caf√© faire les courses faire un bisou", language: "fr", expectedAction: "add_list", type: "list" },
            { command: "Acheter pain lait ≈ìufs beurre", language: "fr", expectedAction: "add_list", type: "shopping" },
            { command: "Liste bricolage: marteau clous tournevis vis", language: "fr", expectedAction: "add_list", type: "list" },
            
            // FRAN√áAIS - Notes vari√©es
            { command: "Note: le code WiFi est 12345", language: "fr", expectedAction: "add_note", type: "note" },
            { command: "Prends note des num√©ros d'urgence", language: "fr", expectedAction: "add_note", type: "note" },
            { command: "Nouvelle note recette de tarte aux pommes", language: "fr", expectedAction: "add_note", type: "note" },
            
            // FRAN√áAIS - Recherches vari√©es
            { command: "Quels sont mes rendez-vous de la semaine", language: "fr", expectedAction: "search_task", type: "task" },
            { command: "Trouve mes t√¢ches urgentes", language: "fr", expectedAction: "search_task", type: "task" },
            { command: "C'est quand mon rendez-vous m√©decin", language: "fr", expectedAction: "search_task", type: "task" },
            { command: "Montre-moi mes m√©dicaments √† prendre aujourd'hui", language: "fr", expectedAction: "search_task", type: "medication" },
            
            // FRAN√áAIS - Suppressions vari√©es
            { command: "Supprime toutes les vieilles t√¢ches", language: "fr", expectedAction: "delete_old_task", type: "task" },
            { command: "Efface les t√¢ches anciennes", language: "fr", expectedAction: "delete_old_task", type: "task" },
            { command: "Supprime ce qui est fait", language: "fr", expectedAction: "delete_done_task", type: "task" },
            { command: "Nettoie les t√¢ches compl√©t√©es", language: "fr", expectedAction: "delete_done_task", type: "task" },
            
            // FRAN√áAIS - T√¢ches r√©currentes vari√©es
            { command: "Rappelle-moi d'appeler maman tous les dimanches √† 10h", language: "fr", expectedAction: "add_recursive_task", type: "task", recurrence: "weekly" },
            { command: "Sortir la poubelle chaque mercredi soir", language: "fr", expectedAction: "add_recursive_task", type: "task", recurrence: "weekly" },
            { command: "Facture √©lectricit√© tous les mois le 5", language: "fr", expectedAction: "add_recursive_task", type: "task", recurrence: "monthly" },
            { command: "Arroser les plantes deux fois par semaine", language: "fr", expectedAction: "add_recursive_task", type: "task", recurrence: "weekly" },
            
            // FRAN√áAIS - Compl√©tion vari√©e
            { command: "C'est fait pour le pain", language: "fr", expectedAction: "complete_task", type: "task" },
            { command: "Termin√© la t√¢che m√©decin", language: "fr", expectedAction: "complete_task", type: "task" },
            { command: "J'ai appel√© le plombier, marque-le fait", language: "fr", expectedAction: "complete_task", type: "task" },
            
            // FRAN√áAIS - Appels vari√©s
            { command: "Appelle les secours", language: "fr", expectedAction: "call", type: "emergency" },
            { command: "Appelle docteur Martin", language: "fr", expectedAction: "call", type: "contact" },
            { command: "T√©l√©phone au SAMU", language: "fr", expectedAction: "call", type: "emergency" },
            
            // FRAN√áAIS - Navigation vari√©e
            { command: "Va au calendrier", language: "fr", expectedAction: "goto_section", section: "calendar" },
            { command: "Ouvre les param√®tres", language: "fr", expectedAction: "goto_section", section: "settings" },
            { command: "Retour aux t√¢ches", language: "fr", expectedAction: "goto_section", section: "tasks" },
            
            // FRAN√áAIS - Questions vari√©es
            { command: "Bonjour comment √ßa va", language: "fr", expectedAction: "conversation", type: "question" },
            { command: "Merci beaucoup", language: "fr", expectedAction: "conversation", type: "question" },
            { command: "Quelle est la m√©t√©o", language: "fr", expectedAction: "conversation", type: "question" },
            
            // FRAN√áAIS - Cas ambigus (edge cases)
            { command: "Rappelle", language: "fr", expectedAction: "conversation", type: "ambiguous" },
            { command: "Ajoute", language: "fr", expectedAction: "conversation", type: "ambiguous" },
            { command: "Liste", language: "fr", expectedAction: "search_task", type: "ambiguous" },
            { command: "Demain", language: "fr", expectedAction: "search_task", type: "ambiguous" }
        ];

        let testResults = [];
        let isRunning = false;

        // Load API key and test results from localStorage
        document.addEventListener('DOMContentLoaded', function() {
            const savedApiKey = localStorage.getItem('mistralApiKey');
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
            }

            const savedTests = localStorage.getItem('customTestCases');
            if (savedTests) {
                const customTests = JSON.parse(savedTests);
                testCases = [...testCases, ...customTests];
            }

            const savedResults = localStorage.getItem('testResults');
            if (savedResults) {
                testResults = JSON.parse(savedResults);
                updateStats();
            }

            renderTests();
            log('System ready. Click "Lancer tous les tests" to start.', 'success');
        });

        function renderTests() {
            const grid = document.getElementById('testGrid');
            grid.innerHTML = '';
            document.getElementById('testCount').textContent = testCases.length;

            testCases.forEach((test, index) => {
                const card = document.createElement('div');
                card.className = 'test-card';
                card.id = `test-${index}`;

                const result = testResults.find(r => r.index === index);
                if (result) {
                    card.classList.add(result.success ? 'success' : 'failed');
                }

                card.innerHTML = `
                    <div class="test-header">
                        <span class="test-lang">${test.language.toUpperCase()}</span>
                        <span style="color: var(--text-muted); font-size: 12px;">#${index + 1}</span>
                    </div>
                    <div class="test-command">"${test.command}"</div>
                    <div class="test-expected">
                        Expected: <strong>${test.expectedAction}</strong>
                        ${test.type ? ` (type: ${test.type})` : ''}
                        ${test.section ? ` (section: ${test.section})` : ''}
                    </div>
                    ${result ? `
                        <div class="test-result ${result.success ? 'success' : 'failed'}">
                            <div><strong>Action:</strong> ${result.actualAction || 'N/A'}</div>
                            ${result.details ? `<div><strong>Details:</strong> ${JSON.stringify(result.details)}</div>` : ''}
                            <div style="margin-top: 5px; color: ${result.success ? 'var(--success-color)' : 'var(--error-color)'};">
                                ${result.success ? '‚úì PASSED' : '‚úó FAILED'}
                            </div>
                            ${result.error ? `<div style="color: var(--error-color); margin-top: 5px;">${result.error}</div>` : ''}
                        </div>
                    ` : ''}
                    <div class="test-actions">
                        <button class="btn-small" onclick="runSingleTest(${index})" ${isRunning ? 'disabled' : ''}>
                            <span class="material-symbols-outlined">play_arrow</span>
                            Test
                        </button>
                        <button class="btn-small btn-secondary" onclick="deleteTest(${index})" ${isRunning ? 'disabled' : ''}>
                            <span class="material-symbols-outlined">delete</span>
                            Supprimer
                        </button>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        async function runAllTests() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert('Veuillez entrer votre cl√© API Mistral');
                return;
            }

            localStorage.setItem('mistralApiKey', apiKey);
            isRunning = true;
            testResults = [];
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('runAllBtn').disabled = true;
            log('=== Starting test suite ===', 'warning');

            for (let i = 0; i < testCases.length; i++) {
                await runSingleTest(i, true);
                await sleep(1000); // Pause entre les tests
            }

            isRunning = false;
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('runAllBtn').disabled = false;
            
            updateStats();
            localStorage.setItem('testResults', JSON.stringify(testResults));
            log('=== Test suite completed ===', 'success');
        }

        async function runSingleTest(index, skipRender = false) {
            const test = testCases[index];
            const card = document.getElementById(`test-${index}`);
            
            if (!skipRender) {
                const apiKey = document.getElementById('apiKey').value.trim();
                if (!apiKey) {
                    alert('Veuillez entrer votre cl√© API Mistral');
                    return;
                }
                localStorage.setItem('mistralApiKey', apiKey);
            }

            card.classList.remove('success', 'failed');
            card.classList.add('running');
            
            log(`Running test #${index + 1}: "${test.command}"`, 'warning');

            try {
                const response = await sendToMistral(test.command, test.language);
                
                const success = response.action === test.expectedAction;
                const result = {
                    index,
                    command: test.command,
                    expectedAction: test.expectedAction,
                    actualAction: response.action,
                    details: response,
                    success,
                    timestamp: new Date().toISOString()
                };

                testResults = testResults.filter(r => r.index !== index);
                testResults.push(result);

                card.classList.remove('running');
                card.classList.add(success ? 'success' : 'failed');

                log(`Test #${index + 1}: ${success ? 'PASSED ‚úì' : 'FAILED ‚úó'} (Expected: ${test.expectedAction}, Got: ${response.action})`, success ? 'success' : 'error');

                if (!skipRender) {
                    renderTests();
                    updateStats();
                    localStorage.setItem('testResults', JSON.stringify(testResults));
                }

                return result;

            } catch (error) {
                log(`Test #${index + 1}: ERROR - ${error.message}`, 'error');
                
                const result = {
                    index,
                    command: test.command,
                    expectedAction: test.expectedAction,
                    actualAction: null,
                    error: error.message,
                    success: false,
                    timestamp: new Date().toISOString()
                };

                testResults = testResults.filter(r => r.index !== index);
                testResults.push(result);

                card.classList.remove('running');
                card.classList.add('failed');

                if (!skipRender) {
                    renderTests();
                    updateStats();
                    localStorage.setItem('testResults', JSON.stringify(testResults));
                }

                return result;
            }
        }

        // D√©tection d'action par mots-cl√©s (copi√© de mistral-agent.js)
        function detectActionByKeywords(text) {
            const txt = text.toLowerCase();
            
            // üî¥ APPELS - D√©tection forte
            if (/\bappelle\b|\bt√©l√©phone\b|\bphone\b|\bcall\b|\bchiama\b|\btelefona\b/.test(txt)) {
                return 'call';
            }
            
            // üî¥ NAVIGATION - D√©tection forte
            if (/(montre|affiche|show|vai|go to|va dans|open|ouvre).*(calendrier|calendar|calendario|param√®tre|setting|impostazioni|statistique|stat|rapport)/.test(txt)) {
                return 'nav';
            }
            
            // üî¥ QUESTIONS G√âN√âRALES - D√©tection forte (MAIS PAS SI SUIVI DE TEMPS/DATE POUR ACTION)
            if (/^(quelle heure est-il|what time is it|che ora √®|quelle date|what date|quel jour sommes|what day|bonjour|hello|merci|thank|grazie)/.test(txt)) {
                return 'chat';
            }
            
            // üî¥ T√ÇCHES/LISTES/NOTES - D√©tection forte
            if (/(rappelle|remind|ricorda|ajoute|add|aggiungi|cr√©e|create|crea|supprime|efface|delete|cancella|complete|termin√©|done|cherche|search|trouve|find|liste|list|nota|note|t√¢che|task|compito|n'oublie|don't forget|non dimenticare|modifie|change|d√©place|move|update|annule|undo|d√©fais|retour)/.test(txt)) {
                return 'task';
            }
            
            // üî¥ PHRASES D√âCLARATIVES RENDEZ-VOUS - D√©tection forte
            if (/rendez-vous|appointment|appuntamento|prendre|take|prendere/.test(txt)) {
                return 'task';
            }
            
            // üü° Par d√©faut, utiliser task pour classification Mistral (chang√© de chat √† task)
            return 'task';
        }

        async function sendToMistral(userMessage, language = 'fr') {
            const apiKey = document.getElementById('apiKey').value.trim();
            
            // D√©tection de l'action par mots-cl√©s
            const keywordAction = detectActionByKeywords(userMessage);
            log(`Action d√©tect√©e par mots-cl√©s: ${keywordAction}`, 'info');

            // S√©lection du prompt appropri√©
            let systemPrompt;
            switch (keywordAction) {
                case 'call':
                    systemPrompt = CALL_PROMPT;
                    break;
                case 'nav':
                    systemPrompt = NAV_PROMPT;
                    break;
                case 'chat':
                    systemPrompt = DEFAULT_CHAT_PROMPT;
                    break;
                case 'task':
                default:
                    systemPrompt = TASK_PROMPT;
                    break;
            }

            try {
                const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'mistral-small-latest',
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userMessage }
                        ],
                        temperature: 0.3,
                        max_tokens: 500,
                        response_format: { type: 'json_object' }
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                const content = data.choices[0].message.content;
                log(`Mistral response: ${content.substring(0, 100)}...`, 'info');
                
                // Parse JSON response
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error('No JSON found in response');
                }

                return JSON.parse(jsonMatch[0]);

            } catch (error) {
                log(`Error in sendToMistral: ${error.message}`, 'error');
                throw error;
            }
        }

        function updateStats() {
            const total = testResults.length;
            const success = testResults.filter(r => r.success).length;
            const failed = total - success;
            const rate = total > 0 ? Math.round((success / total) * 100) : 0;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statSuccess').textContent = success;
            document.getElementById('statFailed').textContent = failed;
            document.getElementById('statRate').textContent = rate + '%';
        }

        function toggleNewTestForm() {
            const form = document.getElementById('newTestForm');
            form.classList.toggle('show');
        }

        function addCustomTest() {
            const command = document.getElementById('testCommand').value.trim();
            const language = document.getElementById('testLanguage').value;
            const expectedAction = document.getElementById('testExpectedAction').value;

            if (!command) {
                alert('Veuillez entrer une commande vocale');
                return;
            }

            testCases.push({
                command,
                language,
                expectedAction,
                type: 'custom',
                custom: true
            });

            // Save custom tests
            const customTests = testCases.filter(t => t.custom);
            localStorage.setItem('customTestCases', JSON.stringify(customTests));

            // Clear form
            document.getElementById('testCommand').value = '';
            toggleNewTestForm();
            renderTests();
            log(`Added custom test: "${command}"`, 'success');
        }

        function deleteTest(index) {
            if (!confirm('Supprimer ce test?')) return;

            testCases.splice(index, 1);
            testResults = testResults.filter(r => r.index !== index);
            
            // Update custom tests
            const customTests = testCases.filter(t => t.custom);
            localStorage.setItem('customTestCases', JSON.stringify(customTests));
            localStorage.setItem('testResults', JSON.stringify(testResults));

            renderTests();
            updateStats();
            log(`Deleted test #${index + 1}`, 'warning');
        }

        function exportResults() {
            const report = {
                timestamp: new Date().toISOString(),
                stats: {
                    total: testResults.length,
                    success: testResults.filter(r => r.success).length,
                    failed: testResults.filter(r => !r.success).length
                },
                results: testResults
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mistral-test-results-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            log('Results exported', 'success');
        }

        function clearResults() {
            if (!confirm('Effacer tous les r√©sultats?')) return;
            
            testResults = [];
            localStorage.removeItem('testResults');
            renderTests();
            updateStats();
            log('Results cleared', 'warning');
        }

        function log(message, type = 'info') {
            const console = document.getElementById('logConsole');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            console.appendChild(entry);
            console.scrollTop = console.scrollHeight;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
